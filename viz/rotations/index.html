<!DOCTYPE html>
<meta charset="utf-8">
<html>
<head>
    <style>
      rect.bordered {
        stroke: #E6E6E6;
        stroke-width:2px;
      }
    </style>
    <script src="//d3js.org/d3.v4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.4.0/d3.min.js"></script>
    <script src="colorbrewer.min.js"></script>
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div id="chart"></div>
<div id="dataset-picker">
</div>
<script type="text/javascript">
function plot_rotations(){
  var margin = { top: 40, right: 150, bottom: 30, left: 170 },
      width = 1200 - margin.left - margin.right,
      height = 510 - margin.top - margin.bottom,
      gridSize = 0,
      legendElementWidth = 0,
      buckets = 9,
      playerColors = colorbrewer.Greys[9],
      max_minute = 0,
      top_team_player_count = 0,
      max_pindex = 0;

  var svg = d3.select("#chart").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

  var heatmapChart = function(csvFile) {
    d3.csv(csvFile,
    function(d) {
      return {
        player: d.player,
        minute: +d.minute,
        value: +d.value,
        pindex: +d.pindex
      };
    },
    function(error, data) {

      data.sort(function(a,b) {
        if (a.pindex == b.pindex)
          return 0;
        if (a.pindex < b.pindex)
          return -1;
        if (a.pindex > b.pindex)
          return 1;
      });

      var players = [],
          previous_pindex = 0;

      $.each(data, function(i, d) {
        if ($.inArray(this.player, players) === -1) {
          if (this.pindex - previous_pindex > 1) {
            players.push("");
            top_team_player_count=this.pindex-1;
          }
          players.push(this.player);
        }
        previous_pindex = this.pindex;

        if(this.pindex > max_pindex) {
          max_pindex = this.pindex;
        }

        if(this.minute > max_minute) {
          max_minute = this.minute;
        }
      });

      gridSize = Math.floor(width / max_minute);
      legendElementWidth = gridSize*3;

      var playerLabels = svg.selectAll(".playerLabel")
          .data(players)
          .enter().append("text")
            .text(function (d) { return d; })
            .attr("x", 0)
            .attr("y", function (d, i) { return (i * gridSize); })
            .style("text-anchor", "end")
            .attr("transform", "translate(-6," + gridSize / 1.5 + ")")
            .attr("class", "dayLabel axis axis-workweek");

      minutes = ["Q1","","","","","","","","","","","","Q2","","","","","","","","","","","","Q3","","","","","","","","","","","","Q4","","","","","","","","","","","end"];

      var timeLabels = svg.selectAll(".timeLabel")
          .data(minutes)
          .enter().append("text")
            .text(function(d) { return d; })
            .attr("x", function(d, i) { return (i * gridSize); })
            .attr("y", top_team_player_count * gridSize)
            .style("text-anchor", "middle")
            .attr("transform", "translate(" + (gridSize - 13) * 2 + ", -6)")
            .attr("class", "timeLabel mono axis axis-worktime");

      var playerColorScale = d3.scaleQuantile()
          .domain([0, buckets - 1, d3.max(data, function (d) { return d.value; })])
          .range(playerColors);

      var cards = svg.selectAll(".hour")
          .data(data, function(d) {return d.pindex+':'+d.minute;});

      cards.append("title");

      cards.enter().append("rect")
          .attr("x", function(d) { return (d.minute - 1) * gridSize; })
          .attr("y", function(d) { return (d.pindex - 1) * gridSize; })
          .attr("rx", 4)
          .attr("ry", 4)
          .attr("class", "hour bordered")
          .attr("width", gridSize)
          .attr("height", gridSize)
          .style("fill", function(d) { return playerColorScale(d.value)});

      cards.select("title").text(function(d) { return d.value; });

      cards.exit().remove();

      var legend = svg.selectAll(".legend")
          .data([0].concat(playerColorScale.quantiles()), function(d) { return d; });

      var legend_y_shift = 0;

      legend.enter().append("g")
          .attr("class", "legend")
          .append("rect")
          .attr("x", function(d, i) {return legendElementWidth * i; })
          .attr("y", height - legend_y_shift)
          .attr("width", legendElementWidth)
          .attr("height", gridSize)
          .style("fill", function(d, i) { return playerColors[i]; });

      legend.enter().append("text")
        .style("fill", function(d) { return playerColorScale(d < 30? 60 : 0);})
        .text(function(d, i) { return " â‰¥ " + Math.round(d); })
        .attr("x", function(d, i) { return legendElementWidth * i; })
        .attr("y", height + gridSize - legend_y_shift - 3)
        .attr("class", "legend");

      svg.selectAll(".legendLabel")
        .data(["Seconds Played in Minute"])
        .enter()
        .append("text")
        .text(function(d) {return d;})
        .attr("y", height + gridSize - (legend_y_shift + 3))
        .attr("x", function() { return (legend.enter().data().length * legendElementWidth) + 5})
        .attr("class", "legend");

      legend.exit().remove();
    });
  };
  heatmapChart("./data.csv");
}

plot_rotations()


</script>
</body>
</html>
